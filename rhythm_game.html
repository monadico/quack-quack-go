<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackest Luxury Car - Rhythm Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        canvas {
            border: 2px solid #00ffff;
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        
        .ui {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
        }
        
        .controls {
            font-size: 14px;
            text-align: center;
            color: #ccc;
        }
        
        button {
            background: #00ffff;
            border: none;
            padding: 10px 20px;
            color: black;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }
        
        button:hover {
            background: #33ffff;
        }
        
        button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="ui">
            <div class="score">Score: <span id="score">0</span></div>
            <button id="playButton">Play</button>
            <div class="controls">
                Controls: D, F, J, K keys<br>
                Hit the notes when they reach the bottom line!
            </div>
        </div>
    </div>

    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const playButton = document.getElementById('playButton');
        
        let audio;
        let gameRunning = false;
        let score = 0;
        let notes = [];
        let noteSpeed = 4;
        let gameStartTime = 0;
        
        // Game configuration
        const LANES = 4; // A, S, D, F keys
        const LANE_WIDTH = canvas.width / LANES;
        const HIT_LINE_Y = canvas.height - 100;
        const NOTE_HEIGHT = 20;
        const HIT_TOLERANCE = 50;
        
        // Key mappings
        const KEY_MAP = {
            'd': 0, 'D': 0,
            'f': 1, 'F': 1,
            'j': 2, 'J': 2,
            'k': 3, 'K': 3
        };
        
        // Note patterns for the song (simplified timing)
        const NOTE_CHART = [
            // Format: [time_in_seconds, lane]
            [3.46057, 0],
            [4.22573, 2],
            [4.85778, 0],
            [5.57444, 2],
            [6.23005, 0],
            [6.88974, 2],
            [7.54007, 0],
            [8.22599, 2],
            [8.86556, 0],
            [9.56490, 2],
            [10.18839, 0],
            [10.34244, 1],
            [10.53395, 2],
            [10.67089, 3],
            [11.24072, 0],
            [11.25177, 3],
            [11.57241, 2],
            [11.91933, 3],
            [12.06975, 1],
            [12.41044, 2],
            [12.58225, 3],
            [12.92885, 0],
            [13.26712, 2],
            [13.41433, 1],
            [13.79694, 3],
            [13.94333, 0],
            [14.28388, 2],
            [14.63574, 1],
            [14.77772, 3],
            [15.12412, 0],
            [15.29925, 2],
            [15.64737, 1],
            [15.98437, 3],
            [16.12007, 0],
            [16.46653, 2],
            [16.62881, 1],
            [17.01149, 3],
            [17.43316, 3],
            [18.33122, 0],
            [18.82213, 0],
            [19.66809, 2],
            [20.20109, 2],
            [20.99557, 0],
            [21.18362, 1],
            [21.35896, 2],
            [21.50993, 3],
            [22.04768, 0],
            [22.05983, 3],
            [22.42225, 2],
            [22.72259, 1],
            [22.85765, 3],
            [23.22523, 0],
            [24.05659, 2],
            [24.21593, 1],
            [24.53856, 3],
            [24.69224, 0],
            [25.42587, 2],
            [25.55137, 1],
            [25.92426, 3],
            [26.07759, 0],
            [26.76147, 2],
            [26.90419, 1],
            [27.24454, 3],
            [27.40580, 0],
            [27.76990, 0],
            [27.91659, 1],
            [28.11672, 2],
            [28.28617, 3],
            [28.76592, 2],
            [28.97573, 3],
            [29.48047, 0],
            [29.64253, 1],
            [30.15815, 2],
            [30.80626, 0],
            [30.95201, 1],
            [31.44475, 3],
            [31.78077, 2],
            [31.97847, 3],
            [32.14013, 0],
            [32.32850, 2],
            [33.51959, 0],
            [33.85351, 1],
            [34.01328, 2],
            [34.34737, 3],
            [34.65288, 0],
            [34.83423, 1],
            [35.00869, 2],
            [35.20218, 3],
            [35.32649, 0],
            [35.50725, 1],
            [35.72612, 2],
            [35.79706, 3],
            [35.90889, 2],
            [36.30156, 1],
            [36.66219, 0],
            [36.85410, 1],
            [37.04017, 0],
            [37.24424, 1],
            [37.37005, 0],
            [37.67457, 3],
            [38.02534, 2],
            [38.12345, 3],
            [38.18186, 2],
            [38.35710, 3],
            [38.38772, 2],
            [38.73663, 0],
            [38.89582, 1],
            [39.09866, 0],
            [39.24128, 1],
            [39.44404, 2],
            [39.60753, 3],
            [39.73951, 0],
            [39.90803, 1],
            [40.11070, 0],
            [40.37315, 1],
            [40.71945, 0],
            [40.90544, 1],
            [40.91022, 0],
            [40.94904, 1],
            [41.06416, 0],
            [41.43061, 2],
            [41.53993, 1],
            [41.72583, 3],
            [41.92668, 0],
            [42.06663, 2],
            [42.47898, 1],
            [42.76652, 3],
            [42.92987, 3],
            [43.15258, 3],
            [43.60989, 3],
            [44.12877, 3],
            [44.27432, 3],
            [45.01315, 2],
            [45.15595, 1]
        ];
        
        class Note {
            constructor(lane, spawnTime) {
                this.lane = lane;
                this.spawnTime = spawnTime;
                this.y = -NOTE_HEIGHT;
                this.hit = false;
                this.x = lane * LANE_WIDTH + LANE_WIDTH / 2 - 25;
                this.width = 50;
                this.height = NOTE_HEIGHT;
            }
            
            update() {
                this.y += noteSpeed;
            }
            
            draw(ctx) {
                if (this.hit) return;
                
                // Note body
                ctx.fillStyle = '#00ffff';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // Note border
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(this.x, this.y, this.width, this.height);
            }
            
            isInHitRange() {
                return Math.abs(this.y + this.height - HIT_LINE_Y) < HIT_TOLERANCE;
            }
            
            hasPassedHitLine() {
                return this.y > HIT_LINE_Y + HIT_TOLERANCE;
            }
        }
        
        function initAudio() {
            audio = new Audio('[Muse Dash⧸Cytus II⧸BOFU2017] Blackest Luxury Car - Chicala Lpis 【音源】 【高音質】.mp3');
            audio.addEventListener('loadeddata', () => {
                playButton.disabled = false;
                playButton.textContent = 'Play';
            });
            audio.addEventListener('error', (e) => {
                console.error('Audio loading error:', e);
                playButton.textContent = 'Audio Error';
            });
        }
        
        function startGame() {
            if (gameRunning) return;
            
            gameRunning = true;
            score = 0;
            notes = [];
            gameStartTime = Date.now();
            
            playButton.disabled = true;
            playButton.textContent = 'Playing...';
            
            audio.currentTime = 0;
            audio.play();
            
            gameLoop();
        }
        
        function spawnNotes() {
            const currentTime = (Date.now() - gameStartTime) / 1000;
            
            NOTE_CHART.forEach(([noteTime, lane]) => {
                const timeToSpawn = noteTime - (canvas.height / noteSpeed) / 60; // Spawn early so note reaches bottom at right time
                
                if (currentTime >= timeToSpawn && !notes.some(n => n.spawnTime === noteTime && n.lane === lane)) {
                    notes.push(new Note(lane, noteTime));
                }
            });
        }
        
        function updateNotes() {
            notes.forEach(note => {
                if (!note.hit) {
                    note.update();
                }
            });
            
            // Remove notes that have passed the screen
            notes = notes.filter(note => note.y < canvas.height + 50 && !note.hasPassedHitLine());
        }
        
        function drawGame() {
            // Clear canvas
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw lanes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let i = 1; i < LANES; i++) {
                const x = i * LANE_WIDTH;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // Draw hit line
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, HIT_LINE_Y);
            ctx.lineTo(canvas.width, HIT_LINE_Y);
            ctx.stroke();
            
            // Draw lane labels
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ['D', 'F', 'J', 'K'].forEach((key, i) => {
                ctx.fillText(key, i * LANE_WIDTH + LANE_WIDTH / 2, HIT_LINE_Y + 30);
            });
            
            // Draw notes
            notes.forEach(note => note.draw(ctx));
            
            // Update score display
            scoreElement.textContent = score;
        }
        
        function handleKeyPress(event) {
            if (!gameRunning) return;
            
            const lane = KEY_MAP[event.key];
            if (lane === undefined) return;
            
            // Find notes in hit range for this lane
            const hittableNotes = notes.filter(note => 
                !note.hit && note.lane === lane && note.isInHitRange()
            );
            
            if (hittableNotes.length > 0) {
                // Hit the closest note
                const closestNote = hittableNotes.reduce((closest, note) => 
                    Math.abs(note.y + note.height - HIT_LINE_Y) < 
                    Math.abs(closest.y + closest.height - HIT_LINE_Y) ? note : closest
                );
                
                closestNote.hit = true;
                score += 100;
                
                // Visual feedback
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fillRect(lane * LANE_WIDTH, HIT_LINE_Y - 20, LANE_WIDTH, 40);
            }
        }
        
        function gameLoop() {
            if (!gameRunning) return;
            
            spawnNotes();
            updateNotes();
            drawGame();
            
            // Check if song is finished
            if (audio.ended) {
                endGame();
                return;
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function endGame() {
            gameRunning = false;
            playButton.disabled = false;
            playButton.textContent = 'Play Again';
        }
        
        // Event listeners
        playButton.addEventListener('click', startGame);
        document.addEventListener('keydown', handleKeyPress);
        
        // Initialize
        initAudio();
    </script>
</body>
</html>