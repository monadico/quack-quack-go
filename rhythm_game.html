<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackest Luxury Car - Rhythm Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            color: white;
            overflow: hidden;
        }
        
        .menu-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            text-align: center;
            animation: fadeIn 1s ease-in;
        }
        
        .menu-container.hidden {
            display: none;
        }
        
        .game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .game-container.active {
            display: flex;
            animation: slideIn 0.5s ease-out;
        }
        
        .settings-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            max-width: 600px;
            width: 90%;
        }
        
        .settings-container.active {
            display: flex;
            animation: slideIn 0.5s ease-out;
        }
        
        .song-select-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            max-width: 800px;
            width: 90%;
        }
        
        .song-select-container.active {
            display: flex;
            animation: slideIn 0.5s ease-out;
        }
        
        .song-select-title {
            font-size: 2.5em;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 20px;
        }
        
        .song-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            width: 100%;
        }
        
        .song-card {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        }
        
        .song-card:hover {
            border-color: #33ffff;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 255, 255, 0.4);
        }
        
        .song-card.selected {
            border-color: #ff6600;
            background: rgba(255, 102, 0, 0.1);
        }
        
        .song-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 8px;
        }
        
        .song-artist {
            color: #ccc;
            margin-bottom: 12px;
            font-style: italic;
        }
        
        .song-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #999;
        }
        
        .song-difficulty {
            background: #ff6600;
            color: black;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .song-info {
            display: flex;
            gap: 15px;
        }
        
        .settings-title {
            font-size: 2.5em;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 20px;
        }
        
        .settings-section {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 25px;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        }
        
        .settings-section h3 {
            color: #00ffff;
            margin: 0 0 20px 0;
            font-size: 1.3em;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
        }
        
        .setting-item:last-child {
            margin-bottom: 0;
        }
        
        .setting-label {
            color: #ccc;
            font-size: 1.1em;
            min-width: 150px;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .volume-slider {
            flex: 1;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .volume-value {
            color: #00ffff;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }
        
        .key-mapping {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .key-button {
            background: #333;
            border: 2px solid #666;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            min-width: 50px;
            transition: all 0.3s ease;
        }
        
        .key-button:hover {
            border-color: #00ffff;
            background: #444;
        }
        
        .key-button.listening {
            border-color: #ff0000;
            background: #660000;
            animation: pulse 1s infinite;
        }
        
        .lane-label {
            color: #00ffff;
            font-weight: bold;
            min-width: 80px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .game-title {
            font-size: 3.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00);
            background-size: 200% 200%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbowShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            margin-bottom: 10px;
        }
        
        .game-subtitle {
            font-size: 1.2em;
            color: #ccc;
            margin-bottom: 40px;
            font-style: italic;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 250px;
        }
        
        .menu-btn {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            border: none;
            padding: 15px 30px;
            color: black;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }
        
        .menu-btn:hover {
            background: linear-gradient(45deg, #33ffff, #3399ff);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.5);
        }
        
        .menu-btn:active {
            transform: translateY(0);
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00ffff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }
        
        .back-btn.active {
            display: block;
        }
        
        .back-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes rainbowShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        canvas {
            border: 2px solid #00ffff;
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        
        .ui {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
        }
        
        .controls {
            font-size: 14px;
            text-align: center;
            color: #ccc;
        }
        
        button {
            background: #00ffff;
            border: none;
            padding: 10px 20px;
            color: black;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }
        
        button:hover {
            background: #33ffff;
        }
        
        button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <button class="back-btn" id="backBtn">← Back to Menu</button>
    
    <div class="menu-container" id="menuContainer">
        <div class="game-title">BLACKEST LUXURY CAR</div>
        <div class="game-subtitle">Rhythm Game</div>
        <div class="menu-buttons">
            <button class="menu-btn" id="playBtn">Play Game</button>
            <button class="menu-btn" id="practiceBtn">Practice Mode</button>
            <button class="menu-btn" id="settingsBtn">Settings</button>
            <button class="menu-btn" id="aboutBtn">About</button>
        </div>
    </div>
    
    <div class="game-container" id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="ui">
            <div class="score">Score: <span id="score">0</span></div>
            <button id="startGameButton">Start</button>
            <div class="controls" id="controlsDisplay">
                Controls: D, F, J, K keys<br>
                Hit the notes when they reach the bottom line!
            </div>
        </div>
    </div>
    
    <div class="song-select-container" id="songSelectContainer">
        <div class="song-select-title">SELECT SONG</div>
        <div class="song-list" id="songList">
            <!-- Songs will be populated dynamically -->
        </div>
        <div class="menu-buttons">
            <button class="menu-btn" id="playSongBtn" disabled>Play Selected Song</button>
        </div>
    </div>
    
    <div class="settings-container" id="settingsContainer">
        <div class="settings-title">SETTINGS</div>
        
        <div class="settings-section">
            <h3>Audio</h3>
            <div class="setting-item">
                <div class="setting-label">Master Volume</div>
                <div class="volume-control">
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
                    <div class="volume-value" id="volumeValue">70%</div>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3>Controls</h3>
            <div class="setting-item">
                <div class="setting-label">Lane 1</div>
                <div class="key-mapping">
                    <div class="lane-label">Left:</div>
                    <button class="key-button" id="key0" data-lane="0">D</button>
                </div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Lane 2</div>
                <div class="key-mapping">
                    <div class="lane-label">Center-Left:</div>
                    <button class="key-button" id="key1" data-lane="1">F</button>
                </div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Lane 3</div>
                <div class="key-mapping">
                    <div class="lane-label">Center-Right:</div>
                    <button class="key-button" id="key2" data-lane="2">J</button>
                </div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Lane 4</div>
                <div class="key-mapping">
                    <div class="lane-label">Right:</div>
                    <button class="key-button" id="key3" data-lane="3">K</button>
                </div>
            </div>
        </div>
        
        <div class="menu-buttons">
            <button class="menu-btn" id="saveSettingsBtn">Save Settings</button>
            <button class="menu-btn" id="resetSettingsBtn">Reset to Default</button>
        </div>
    </div>

    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const startGameButton = document.getElementById('startGameButton');
        
        // Menu elements
        const menuContainer = document.getElementById('menuContainer');
        const gameContainer = document.getElementById('gameContainer');
        const settingsContainer = document.getElementById('settingsContainer');
        const songSelectContainer = document.getElementById('songSelectContainer');
        const backBtn = document.getElementById('backBtn');
        const playBtn = document.getElementById('playBtn');
        const practiceBtn = document.getElementById('practiceBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const aboutBtn = document.getElementById('aboutBtn');
        const songList = document.getElementById('songList');
        const playSongBtn = document.getElementById('playSongBtn');
        
        // Settings elements
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const controlsDisplay = document.getElementById('controlsDisplay');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const resetSettingsBtn = document.getElementById('resetSettingsBtn');
        const keyButtons = [
            document.getElementById('key0'),
            document.getElementById('key1'),
            document.getElementById('key2'),
            document.getElementById('key3')
        ];
        
        let audio;
        let gameRunning = false;
        let score = 0;
        let notes = [];
        let noteSpeed = 4;
        let gameStartTime = 0;
        let gameLoopId = null; // Track animation frame for proper cleanup
        
        // Settings variables
        let gameSettings = {
            volume: 70,
            keyMappings: ['d', 'f', 'j', 'k']
        };
        let isListeningForKey = false;
        let listeningLane = -1;
        
        // Song library system
        let currentSong = null;
        let currentNoteChart = [];
        
        // Game configuration
        const LANES = 4; // A, S, D, F keys
        const LANE_WIDTH = canvas.width / LANES;
        const HIT_LINE_Y = canvas.height - 100;
        const NOTE_HEIGHT = 20;
        const HIT_TOLERANCE = 50;
        
        // Key mappings (will be updated from settings)
        let KEY_MAP = {
            'd': 0, 'D': 0,
            'f': 1, 'F': 1,
            'j': 2, 'J': 2,
            'k': 3, 'K': 3
        };
        
        // Song library - easily expandable
        const SONG_LIBRARY = {
            'blackest-luxury-car': {
                id: 'blackest-luxury-car',
                title: 'Blackest Luxury Car',
                artist: 'Chicala Lpis',
                audioFile: '[Muse Dash⧸Cytus II⧸BOFU2017] Blackest Luxury Car - Chicala Lpis 【音源】 【高音質】.mp3',
                difficulty: 'Hard',
                bpm: 180,
                duration: 45, // seconds
                chart: [
                    // Format: [time_in_seconds, lane]
                    [3.46057, 0], [4.22573, 2], [4.85778, 0], [5.57444, 2], [6.23005, 0],
                    [6.88974, 2], [7.54007, 0], [8.22599, 2], [8.86556, 0], [9.56490, 2],
                    [10.18839, 0], [10.34244, 1], [10.53395, 2], [10.67089, 3], [11.24072, 0],
                    [11.25177, 3], [11.57241, 2], [11.91933, 3], [12.06975, 1], [12.41044, 2],
                    [12.58225, 3], [12.92885, 0], [13.26712, 2], [13.41433, 1], [13.79694, 3],
                    [13.94333, 0], [14.28388, 2], [14.63574, 1], [14.77772, 3], [15.12412, 0],
                    [15.29925, 2], [15.64737, 1], [15.98437, 3], [16.12007, 0], [16.46653, 2],
                    [16.62881, 1], [17.01149, 3], [17.43316, 3], [18.33122, 0], [18.82213, 0],
                    [19.66809, 2], [20.20109, 2], [20.99557, 0], [21.18362, 1], [21.35896, 2],
                    [21.50993, 3], [22.04768, 0], [22.05983, 3], [22.42225, 2], [22.72259, 1],
                    [22.85765, 3], [23.22523, 0], [24.05659, 2], [24.21593, 1], [24.53856, 3],
                    [24.69224, 0], [25.42587, 2], [25.55137, 1], [25.92426, 3], [26.07759, 0],
                    [26.76147, 2], [26.90419, 1], [27.24454, 3], [27.40580, 0], [27.76990, 0],
                    [27.91659, 1], [28.11672, 2], [28.28617, 3], [28.76592, 2], [28.97573, 3],
                    [29.48047, 0], [29.64253, 1], [30.15815, 2], [30.80626, 0], [30.95201, 1],
                    [31.44475, 3], [31.78077, 2], [31.97847, 3], [32.14013, 0], [32.32850, 2],
                    [33.51959, 0], [33.85351, 1], [34.01328, 2], [34.34737, 3], [34.65288, 0],
                    [34.83423, 1], [35.00869, 2], [35.20218, 3], [35.32649, 0], [35.50725, 1],
                    [35.72612, 2], [35.79706, 3], [35.90889, 2], [36.30156, 1], [36.66219, 0],
                    [36.85410, 1], [37.04017, 0], [37.24424, 1], [37.37005, 0], [37.67457, 3],
                    [38.02534, 2], [38.12345, 3], [38.18186, 2], [38.35710, 3], [38.38772, 2],
                    [38.73663, 0], [38.89582, 1], [39.09866, 0], [39.24128, 1], [39.44404, 2],
                    [39.60753, 3], [39.73951, 0], [39.90803, 1], [40.11070, 0], [40.37315, 1],
                    [40.71945, 0], [40.90544, 1], [40.91022, 0], [40.94904, 1], [41.06416, 0],
                    [41.43061, 2], [41.53993, 1], [41.72583, 3], [41.92668, 0], [42.06663, 2],
                    [42.47898, 1], [42.76652, 3], [42.92987, 3], [43.15258, 3], [43.60989, 3],
                    [44.12877, 3], [44.27432, 3], [45.01315, 2], [45.15595, 1]
                ]
            }
            // Easy to add more songs here!
        };
        
        class Note {
            constructor(lane, spawnTime) {
                this.lane = lane;
                this.spawnTime = spawnTime;
                this.y = -NOTE_HEIGHT;
                this.hit = false;
                this.x = lane * LANE_WIDTH + LANE_WIDTH / 2 - 25;
                this.width = 50;
                this.height = NOTE_HEIGHT;
            }
            
            update() {
                this.y += noteSpeed;
            }
            
            draw(ctx) {
                if (this.hit) return;
                
                // Note body
                ctx.fillStyle = '#00ffff';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // Note border
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(this.x, this.y, this.width, this.height);
            }
            
            isInHitRange() {
                return Math.abs(this.y + this.height - HIT_LINE_Y) < HIT_TOLERANCE;
            }
            
            hasPassedHitLine() {
                return this.y > HIT_LINE_Y + HIT_TOLERANCE;
            }
        }
        
        function initAudio() {
            if (!currentSong) {
                console.warn('No song selected');
                return;
            }
            
            audio = new Audio(currentSong.audioFile);
            audio.addEventListener('loadeddata', () => {
                startGameButton.disabled = false;
                startGameButton.textContent = 'Start';
                updateAudioVolume(); // Apply current volume setting
            });
            audio.addEventListener('error', (e) => {
                console.error('Audio loading error:', e);
                startGameButton.textContent = 'Audio Error';
            });
        }
        
        function startGame() {
            if (gameRunning) return;
            
            gameRunning = true;
            score = 0;
            notes = [];
            gameStartTime = Date.now();
            
            startGameButton.disabled = true;
            startGameButton.textContent = 'Playing...';
            
            audio.currentTime = 0;
            audio.play();
            
            gameLoop();
        }
        
        function spawnNotes() {
            const currentTime = (Date.now() - gameStartTime) / 1000;
            
            currentNoteChart.forEach(([noteTime, lane]) => {
                const timeToSpawn = noteTime - (canvas.height / noteSpeed) / 60; // Spawn early so note reaches bottom at right time
                
                if (currentTime >= timeToSpawn && !notes.some(n => n.spawnTime === noteTime && n.lane === lane)) {
                    notes.push(new Note(lane, noteTime));
                }
            });
        }
        
        function updateNotes() {
            notes.forEach(note => {
                if (!note.hit) {
                    note.update();
                }
            });
            
            // Remove notes that have passed the screen
            notes = notes.filter(note => note.y < canvas.height + 50 && !note.hasPassedHitLine());
        }
        
        function drawGame() {
            // Clear canvas
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw lanes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let i = 1; i < LANES; i++) {
                const x = i * LANE_WIDTH;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // Draw hit line
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, HIT_LINE_Y);
            ctx.lineTo(canvas.width, HIT_LINE_Y);
            ctx.stroke();
            
            // Draw lane labels (dynamic based on user settings)
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            gameSettings.keyMappings.forEach((key, i) => {
                ctx.fillText(key.toUpperCase(), i * LANE_WIDTH + LANE_WIDTH / 2, HIT_LINE_Y + 30);
            });
            
            // Draw notes
            notes.forEach(note => note.draw(ctx));
            
            // Update score display
            scoreElement.textContent = score;
        }
        
        function handleKeyPress(event) {
            if (!gameRunning) return;
            
            const lane = KEY_MAP[event.key];
            if (lane === undefined) return;
            
            // Find notes in hit range for this lane
            const hittableNotes = notes.filter(note => 
                !note.hit && note.lane === lane && note.isInHitRange()
            );
            
            if (hittableNotes.length > 0) {
                // Hit the closest note
                const closestNote = hittableNotes.reduce((closest, note) => 
                    Math.abs(note.y + note.height - HIT_LINE_Y) < 
                    Math.abs(closest.y + closest.height - HIT_LINE_Y) ? note : closest
                );
                
                closestNote.hit = true;
                score += 100;
                
                // Visual feedback
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fillRect(lane * LANE_WIDTH, HIT_LINE_Y - 20, LANE_WIDTH, 40);
            }
        }
        
        function gameLoop() {
            if (!gameRunning) {
                gameLoopId = null;
                return;
            }
            
            spawnNotes();
            updateNotes();
            drawGame();
            
            // Check if song is finished
            if (audio.ended) {
                endGame();
                return;
            }
            
            gameLoopId = requestAnimationFrame(gameLoop);
        }
        
        function endGame() {
            gameRunning = false;
            
            // Cancel animation frame if active
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            
            startGameButton.disabled = false;
            startGameButton.textContent = 'Play Again';
        }
        
        // Menu navigation functions
        function showMenu() {
            menuContainer.classList.remove('hidden');
            gameContainer.classList.remove('active');
            settingsContainer.classList.remove('active');
            songSelectContainer.classList.remove('active');
            backBtn.classList.remove('active');
            
            // Stop game loop and audio
            stopGame();
            
            // Stop any key listening
            if (isListeningForKey) {
                stopKeyListening();
            }
        }
        
        function stopGame() {
            // Stop game state
            gameRunning = false;
            
            // Cancel animation frame
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            
            // Stop and reset audio
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            
            // Reset game state completely
            score = 0;
            notes = [];
            gameStartTime = 0;
            
            // Reset UI
            startGameButton.disabled = false;
            startGameButton.textContent = 'Start';
            scoreElement.textContent = '0';
            
            // Clear canvas
            ctx.fillStyle = 'rgba(0, 0, 0, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        function showSongSelect() {
            menuContainer.classList.add('hidden');
            songSelectContainer.classList.add('active');
            backBtn.classList.add('active');
            populateSongList();
        }
        
        function hideSongSelect() {
            songSelectContainer.classList.remove('active');
            menuContainer.classList.remove('hidden');
            backBtn.classList.remove('active');
        }
        
        function showGame() {
            menuContainer.classList.add('hidden');
            songSelectContainer.classList.remove('active');
            gameContainer.classList.add('active');
            backBtn.classList.add('active');
            
            // Ensure game is ready to start
            if (audio && audio.readyState >= 2) {
                startGameButton.disabled = false;
                startGameButton.textContent = 'Start';
            }
        }
        
        function showSettings() {
            menuContainer.classList.add('hidden');
            settingsContainer.classList.add('active');
            backBtn.classList.add('active');
            
            // Load current settings
            loadSettings();
            updateSettingsDisplay();
        }
        
        function hideSettings() {
            settingsContainer.classList.remove('active');
            menuContainer.classList.remove('hidden');
            backBtn.classList.remove('active');
        }
        
        function showAbout() {
            alert('Blackest Luxury Car - Rhythm Game\n\nCreated with Claude Code\n\nSong: Blackest Luxury Car by Chicala Lpis\nGenre: Muse Dash/Cytus II/BOFU2017\n\nControls:\nD, F, J, K - Hit notes\nESC - Return to menu\n\nHit the notes when they reach the red line!\nGood luck and have fun!');
        }
        
        // Song selection functions
        function populateSongList() {
            songList.innerHTML = '';
            
            Object.values(SONG_LIBRARY).forEach(song => {
                const songCard = document.createElement('div');
                songCard.className = 'song-card';
                songCard.dataset.songId = song.id;
                
                songCard.innerHTML = `
                    <div class="song-title">${song.title}</div>
                    <div class="song-artist">by ${song.artist}</div>
                    <div class="song-details">
                        <div class="song-info">
                            <span>BPM: ${song.bpm}</span>
                            <span>Duration: ${song.duration}s</span>
                        </div>
                        <div class="song-difficulty">${song.difficulty}</div>
                    </div>
                `;
                
                songCard.addEventListener('click', () => selectSong(song.id));
                songList.appendChild(songCard);
            });
        }
        
        function selectSong(songId) {
            // Remove previous selection
            document.querySelectorAll('.song-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select new song
            document.querySelector(`[data-song-id="${songId}"]`).classList.add('selected');
            currentSong = SONG_LIBRARY[songId];
            currentNoteChart = currentSong.chart;
            playSongBtn.disabled = false;
            
            console.log('Selected song:', currentSong.title);
        }
        
        function loadSelectedSong() {
            if (!currentSong) {
                alert('Please select a song first!');
                return;
            }
            
            // Initialize audio for selected song
            initAudio();
            showGame();
        }
        
        // Menu event listeners
        playBtn.addEventListener('click', showSongSelect);
        practiceBtn.addEventListener('click', () => {
            showSongSelect();
            // Future: Enable practice mode features
        });
        settingsBtn.addEventListener('click', showSettings);
        
        // Song selection button
        playSongBtn.addEventListener('click', loadSelectedSong);
        
        // Update back button to handle all screens
        backBtn.addEventListener('click', () => {
            if (settingsContainer.classList.contains('active')) {
                hideSettings();
            } else if (songSelectContainer.classList.contains('active')) {
                hideSongSelect();
            } else if (gameContainer.classList.contains('active')) {
                // From game, go back to song selection
                stopGame();
                gameContainer.classList.remove('active');
                showSongSelect();
            } else {
                showMenu();
            }
        });
        aboutBtn.addEventListener('click', showAbout);
        
        // Game event listeners
        startGameButton.addEventListener('click', startGame);
        document.addEventListener('keydown', handleKeyPress);
        
        // Settings functionality
        function loadSettings() {
            const saved = localStorage.getItem('rhythmGameSettings');
            if (saved) {
                gameSettings = { ...gameSettings, ...JSON.parse(saved) };
            }
            updateKeyMappings();
            updateAudioVolume();
        }
        
        function saveSettings() {
            localStorage.setItem('rhythmGameSettings', JSON.stringify(gameSettings));
            updateKeyMappings();
            updateAudioVolume();
            updateControlsDisplay();
            alert('Settings saved successfully!');
        }
        
        function resetSettings() {
            gameSettings = {
                volume: 70,
                keyMappings: ['d', 'f', 'j', 'k']
            };
            updateSettingsDisplay();
            updateKeyMappings();
            updateAudioVolume();
            updateControlsDisplay();
            alert('Settings reset to default!');
        }
        
        function updateSettingsDisplay() {
            volumeSlider.value = gameSettings.volume;
            volumeValue.textContent = gameSettings.volume + '%';
            
            keyButtons.forEach((btn, index) => {
                btn.textContent = gameSettings.keyMappings[index].toUpperCase();
            });
        }
        
        function updateKeyMappings() {
            KEY_MAP = {};
            gameSettings.keyMappings.forEach((key, lane) => {
                KEY_MAP[key.toLowerCase()] = lane;
                KEY_MAP[key.toUpperCase()] = lane;
            });
        }
        
        function updateAudioVolume() {
            if (audio) {
                audio.volume = gameSettings.volume / 100;
            }
        }
        
        function updateControlsDisplay() {
            const keys = gameSettings.keyMappings.map(k => k.toUpperCase()).join(', ');
            controlsDisplay.innerHTML = `Controls: ${keys} keys<br>Hit the notes when they reach the bottom line!`;
        }
        
        function startKeyListening(lane) {
            if (isListeningForKey) return;
            
            isListeningForKey = true;
            listeningLane = lane;
            keyButtons[lane].classList.add('listening');
            keyButtons[lane].textContent = '...';
        }
        
        function stopKeyListening() {
            if (!isListeningForKey) return;
            
            isListeningForKey = false;
            keyButtons[listeningLane].classList.remove('listening');
            keyButtons[listeningLane].textContent = gameSettings.keyMappings[listeningLane].toUpperCase();
            listeningLane = -1;
        }
        
        function handleSettingsKeyPress(event) {
            if (!isListeningForKey) return;
            
            event.preventDefault();
            const key = event.key.toLowerCase();
            
            // Prevent duplicate key assignments
            if (gameSettings.keyMappings.includes(key)) {
                alert('Key already assigned! Choose a different key.');
                stopKeyListening();
                return;
            }
            
            // Update the key mapping
            gameSettings.keyMappings[listeningLane] = key;
            stopKeyListening();
            updateSettingsDisplay();
        }
        
        // Volume slider event
        volumeSlider.addEventListener('input', (event) => {
            gameSettings.volume = parseInt(event.target.value);
            volumeValue.textContent = gameSettings.volume + '%';
            updateAudioVolume();
        });
        
        // Key button events
        keyButtons.forEach((btn, index) => {
            btn.addEventListener('click', () => startKeyListening(index));
        });
        
        // Settings button events
        saveSettingsBtn.addEventListener('click', saveSettings);
        resetSettingsBtn.addEventListener('click', resetSettings);
        
        // Handle ESC key to return to menu
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (isListeningForKey) {
                    // Stop key listening first
                    stopKeyListening();
                } else if (settingsContainer.classList.contains('active')) {
                    hideSettings();
                } else if (songSelectContainer.classList.contains('active')) {
                    hideSongSelect();
                } else if (gameContainer.classList.contains('active')) {
                    // From game, stop game and go back to song selection
                    stopGame();
                    gameContainer.classList.remove('active');
                    showSongSelect();
                }
            } else if (isListeningForKey) {
                handleSettingsKeyPress(event);
            }
        });
        
        // Initialize
        loadSettings();
        // Don't init audio immediately - wait for song selection
    </script>
</body>
</html>